!function(e,t,n){e(function(){var a,i,o=e(".wc-shipping-zones"),s=e(".wc-shipping-zone-rows"),l=e(".wc-shipping-zone-save"),d=n.template("wc-shipping-zone-row"),r=n.template("wc-shipping-zone-row-blank"),c=n.template("wcv-trs-rate-row"),u=n.template("wcv-trs-rate-row-blank"),h=e(".wcv-trs-keep-defaults"),b=e(".wcv-trs-delete-defaults"),p=e("#wcv_trs_default_tables_notice"),w={minimumResultsForSearch:1/0,allowClear:e(this).data("allow_clear"),placeholder:e(this).data("placeholder")},f=Backbone.Model.extend({changes:{},logChanges:function(e,t){void 0===t&&(t=!0);var n=this.changes||{};_.each(e,function(e,t){n[t]=_.extend(n[t]||{table_id:t},e)}),this.changes=n,this.trigger("change:tables",t)},discardChanges:function(e){var t=this.changes||{},n=null,a=_.indexBy(this.get("tables"),"table_id");t[e]&&void 0!==t[e].table_order&&(n=t[e].table_order),delete t[e],null!==n&&a[e]&&a[e].table_order!==n&&(t[e]=_.extend(t[e]||{},{table_id:e,table_order:n})),this.changes=t,a[e]&&a[e].is_default&&x(e,a[e]),0===_.size(this.changes)&&k.clearUnloadConfirmation()},save:function(){_.size(this.changes)?e.post(t.ajaxurl,{action:"wcv_trs_save_changes",wcv_trs_nonce:t.wcv_trs_nonce,changes:this.changes,user_id:t.user_id},this.onSaveResponse,"json"):y.trigger("saved:tables")},onSaveResponse:function(e,n){"success"===n&&(e.success?(y.set("tables",e.data.tables),y.trigger("change:tables"),y.changes={},y.trigger("saved:tables")):window.alert(t.strings.save_failed))}}),v=Backbone.View.extend({rowTemplate:d,initialize:function(){this.listenTo(this.model,"change:tables",this.setUnloadConfirmation),this.listenTo(this.model,"saved:tables",this.clearUnloadConfirmation),this.listenTo(this.model,"saved:tables",this.render),this.listenTo(this.model,"saved:tables",this.hideDefaultTablesNotice),s.on("sortupdate",{view:this},this.updateModelOnSort),e(window).on("beforeunload",{view:this},this.unloadConfirmation),l.on("click",{view:this},this.onSubmit),e(document.body).on("click",".wc-shipping-zone-add",{view:this},this.onAddNewTable),e(document.body).on("click",".wc-shipping-zone-edit",{view:this},this.onConfigure),e(document.body).on("click",".wc-shipping-zone-delete",{view:this},this.onDeleteTable),e(document.body).on("click",".trs-table-postcodes-toggle",this.togglePostcodesField),e(document.body).on("wc_backbone_modal_response",this.onConfigureSubmitted)},hideDefaultTablesNotice:function(){p.hide()},block:function(){o.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){o.unblock()},render:function(){var t=_.indexBy(this.model.get("tables"),"table_id"),n=this;n.$el.empty(),n.unblock(),_.size(t)?(t=_.sortBy(t,function(e){return parseInt(e.table_order,10)}),e.each(t,function(e,t){n.renderRow(t)})):n.$el.append(r),n.initRows()},renderRow:function(e){this.$el.append(this.rowTemplate(e))},initRows:function(){0==e("tbody.wc-shipping-zone-rows tr").length%2?o.find("tbody.wc-shipping-zone-rows").next("tbody").find("tr").addClass("odd"):o.find("tbody.wc-shipping-zone-rows").next("tbody").find("tr").removeClass("odd"),this.initTips()},initTips:function(){e("#tiptip_holder").removeAttr("style"),e("#tiptip_arrow").removeAttr("style"),e(".tips, .woocommerce-help-tip").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:50})},onSubmit:function(e){e.preventDefault(),e.data.view.block(),e.data.view.model.save()},onConfigure:function(t){var n=e(this).closest("tr").data("id"),a=t.data.view,i=a.model,o=_.indexBy(i.get("tables"),"table_id"),s={};n in o&&(s=o[n]),a.openEditModal(s)},openEditModal:function(t){event.preventDefault(),e(this).WCBackboneModal({template:"wc-modal-shipping-table",variable:{table_id:t.table_id,table:t},data:{table_id:t.table_id,table:t}}),this.initModal(t)},initModal:function(t){jQuery("#wcv_trs_is_enabled").find('option[value="'+t.is_enabled+'"]').prop("selected",!0),jQuery("#wcv_trs_table_method").find('option[value="'+t.table_method+'"]').prop("selected",!0),_.each(t.table_locations,function(t){"string"===jQuery.type(t)?e('option[value="'+t+'"]').prop("selected",!0):e('option[value="'+t.type+":"+t.code+'"]').prop("selected",!0)}),new g({model:new m({rates:t.formatted_table_rates?t.formatted_table_rates:[]})}).render(),e(".wc-enhanced-select:not(.enhanced)").select2(w).addClass("enhanced"),this.initTips()},togglePostcodesField:function(t){t.preventDefault(),e(this).hide(),e(".trs-table-postcodes").show()},onConfigureSubmitted:function(e,t,n){if("wc-modal-shipping-table"===t){var a=k.model,i=_.indexBy(a.get("tables"),"table_id"),o=n.table_id,s=i[o],d={};d[o]={formatted_table_rates:{}};var r=/([^\[]+)\[(.+)]/;_.each(n,function(e,t){if(t.startsWith("threshold")||t.startsWith("rate")||t.startsWith("is_percent")){var n=r.exec(t),a=n[1],i=n[2];d[o].formatted_table_rates[i]||(d[o].formatted_table_rates[i]={rate_id:i}),d[o].formatted_table_rates[i][a]=e}else"table_id"!==t&&(d[o][t.replace("wcv_trs_","")]=e)}),s&&_.each(d[o],function(e,t){s[t]=e}),_.isEmpty(d[o].formatted_table_rates)&&(d[o].formatted_table_rates=""),a.logChanges(d),l.trigger("click")}},onAddNewTable:function(e){e.preventDefault();var n=e.data.view,a=n.model,i=_.indexBy(a.get("tables"),"table_id"),o=_.size(i),s=_.extend({},t.default_table,{table_id:"new-"+o+"-"+Date.now()});s.table_order=1+_.max(_.pluck(i,"table_order"),function(e){return parseInt(e,10)}),n.openEditModal(s)},onDeleteTable:function(t){var n=t.data.view,a=n.model,i=_.indexBy(a.get("tables"),"table_id"),o={},s=e(this).closest("tr"),l=e(this).closest("tr").data("id");t.preventDefault(),i[l]&&(delete i[l],o[l]=_.extend(o[l]||{},{deleted:"deleted"}),a.set("tables",i),a.logChanges(o)),s.remove(),n.initRows()},setUnloadConfirmation:function(e){this.needsUnloadConfirm=e,l.prop("disabled",!1)},clearUnloadConfirmation:function(){this.needsUnloadConfirm=!1,l.prop("disabled",!0)},unloadConfirmation:function(e){if(e.data.view.needsUnloadConfirm)return e.returnValue=t.strings.unload_confirmation_msg,window.event.returnValue=t.strings.unload_confirmation_msg,t.strings.unload_confirmation_msg},updateModelOnSort:function(t){var n=t.data.view.model,a=_.indexBy(n.get("tables"),"table_id"),i=e("tbody.wc-shipping-zone-rows tr"),o={};_.each(i,function(t){var n=e(t).data("id"),i=null,s=parseInt(e(t).index(),10);a[n]&&(i=parseInt(a[n].table_order,10)),i!==s&&(o[n]=_.extend(o[n]||{},{table_order:s}))}),_.size(o)&&n.logChanges(o)}}),m=Backbone.Model.extend({rates:[]}),g=Backbone.View.extend({rowTemplate:c,rateBody:null,initialize:function(){this.rateBody=e(".wcv-trs-rates-rows"),e("#wcv_trs_table_method").on("change",this.updateMethod),e(document.body).on("click",".wcv-trs-rate-add",{view:this},this.onAddNewRow)},render:function(){var t=this,n=t.model,a=_.indexBy(n.get("rates"),"rate_id"),i=t.rateBody;i.empty(),_.size(a)?(e.each(a,function(e,n){t.renderRow(n)}),t.updateMethod()):i.append(u)},renderRow:function(e){this.rateBody.append(this.rowTemplate(e)),this.initRow(e)},initRow:function(e){var t=this.rateBody.find('tr[data-id="'+e.rate_id+'"]');t.find('option[value="'+e.is_percent+'"]').prop("selected",!0),t.find(".wcv-trs-rate-delete").on("click",{view:this},this.onDeleteRow)},updateMethod:function(){var n=e("#wcv_trs_table_method").val(),a=e(".wcv-trs-calc-method");switch(e(".wcv-trs-rate-threshold-before, .wcv-trs-rate-threshold-after").html(""),a.text(""),n){case"weighttotal":e(".wcv-trs-rate-threshold-after").html(t.strings.weight_unit),a.text(t.strings.weight);break;case"subtotal":e(".wcv-trs-rate-threshold-before").html(t.strings.currency_symbol),a.text(t.strings.subtotal);break;case"itemcount":a.text(t.strings.item_count)}},onAddNewRow:function(n){n.preventDefault();var a=n.data.view,i=a.model,o=_.indexBy(i.get("rates"),"rate_id"),s=_.size(o),l=_.extend({},t.default_rate,{rate_id:"new-"+s+"-"+Date.now()});e(".wcv-trs-rates-blank-state").closest("tr").remove(),a.renderRow(l),a.updateMethod()},onDeleteRow:function(t){t.preventDefault(),e(this).closest("tr").remove()}}),y=new f({tables:t.tables}),k=new v({model:y,el:s});function x(e,t){var n=y,a={};a[e]={},_.each({table_id:null,table_name:null,table_order:null,table_locations:function(e){return e.type+":"+e.code},table_method:null,table_fee:null,is_enabled:null,formatted_table_rates:function(e,t){return e.rate_id="new-"+t,e}},function(n,i){a[e][i]=null!==n?_.map(t[i],n):t[i]}),n.logChanges(a,!1)}function C(n){k.block(),e.ajax({type:"post",url:t.ajaxurl,data:{action:"wcv_trs_"+n+"_default_tables",wcv_trs_nonce:t.wcv_trs_nonce,user_id:t.user_id},success:y.onSaveResponse,complete:k.unblock})}k.render(),s.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.wc-shipping-zone-sort",scrollSensitivity:40}),e(window).load(function(){if(void 0!==window.Ink){var t=window.Ink.UI.Common_1.getInstance(".wcv-tabs")[0],n=e('.wcv-form input[type="submit"]').last();t._options.onChange=a,a(t)}function a(e){var t=e.activeTab();n.toggle("shipping-custom"!==t)}}),p.length>0&&(a=y,i=_.indexBy(a.get("tables"),"table_id"),_.each(i,function(e,t){i[t].is_default=!0,x(t,e)})),h.one("click",function(e){e.preventDefault(),C("keep")}),b.one("click",function(e){e.preventDefault(),C("delete")})})}(jQuery,wcv_trs_localize,wp);